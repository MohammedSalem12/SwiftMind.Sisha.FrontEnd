<div class="students-hero">
  <div class="hero-left">
    <h1>Students</h1>
    <p class="subtitle">Manage your students — quick view, enroll or inspect details.</p>
  </div>
  <div class="hero-right">
    <input class="search" placeholder="Search by name or code" [ngModel]="filter()" (ngModelChange)="onFilter($event)" />
    <button class="btn-primary" (click)="onFilter(filter())">Search</button>
  </div>
</div>

<div *ngIf="loading()" class="loading">Loading students...</div>

<div class="cards-grid">
  <div *ngFor="let s of students(); trackBy: trackById" class="card">
    <div class="card-avatar">
      <img *ngIf="getAvatarUrl(s)" [src]="getAvatarUrl(s)" alt="avatar" />
      <span *ngIf="!getAvatarUrl(s)">{{ (s.firstName?.[0] || '-') + (s.lastName?.[0] || '') }}</span>
    </div>
    <div class="card-body">
      <div class="card-title">{{ s.firstName }} {{ s.lastName }}</div>
      <div class="card-sub">Grade {{ s.currentGrade }} • {{ s.schoolName || '-' }}</div>
      <div class="card-meta">Code: <span class="muted">{{ s.studentCode }}</span></div>
    </div>
    <div class="card-actions">
      <button class="btn-outline" (click)="showDetails(s)">Details</button>
      <button class="btn" (click)="goToEnroll(s.id)">Enroll</button>
    </div>
  </div>
</div>

<!-- Details modal -->
<div class="modal-backdrop" *ngIf="selected()">
  <div class="modal-card">
    <div class="modal-header">
      <h3>{{ selected()?.firstName }} {{ selected()?.middleName || '' }} {{ selected()?.lastName }}</h3>
      <button class="close" (click)="closeDetails()">✕</button>
    </div>
    <div class="modal-body">
      <div class="detail-top">
        <div class="detail-avatar">
          <img *ngIf="getAvatarUrl(selected())" [src]="getAvatarUrl(selected())" alt="avatar" />
          <div *ngIf="!getAvatarUrl(selected())" class="initials">{{ (selected()?.firstName?.[0] || '-') + (selected()?.lastName?.[0] || '') }}</div>
        </div>
        <div class="detail-summary">
          <div class="row"><strong>Student code:</strong> {{ selected()?.studentCode }}</div>
          <div class="row"><strong>Grade:</strong> {{ selected()?.currentGrade }}</div>
          <div class="row"><strong>School:</strong> {{ selected()?.schoolName || '-' }}</div>
        </div>
      </div>

      <h4>Monthly Attendance (last 6 months)</h4>
      <div class="attendance-row">
        <div *ngFor="let m of monthlyAttendance()" class="attendance-item">
          <div class="progress-circle" [attr.data-percent]="m.percent">
            <svg viewBox="0 0 36 36">
              <path class="bg" d="M18 2.0845a15.9155 15.9155 0 1 0 0 31.831 15.9155 15.9155 0 1 0 0-31.831" />
              <path class="progress" [attr.stroke-dasharray]="m.percent + ', 100'" d="M18 2.0845a15.9155 15.9155 0 1 0 0 31.831 15.9155 15.9155 0 1 0 0-31.831" />
            </svg>
            <div class="percent">{{ m.percent }}%</div>
            <div class="month">{{ m.month }}</div>
          </div>
        </div>
      </div>

      <h4>Enrolled Courses</h4>
      <div *ngIf="enrolledCourses().length === 0" class="muted">No enrolled courses found.</div>
      <ul>
        <li *ngFor="let c of enrolledCourses()">{{ c.nameEn || c.nameAr || c.code || 'Unnamed Course' }}</li>
      </ul>
      <div class="row"><strong>Address:</strong> {{ selected()?.address || '-' }}</div>
      <div class="row small muted">Created: {{ selected()?.creationTime }} • Modified: {{ selected()?.lastModificationTime || '-' }}</div>
    </div>
    <div class="modal-actions">
      <button class="btn" (click)="goToEnroll(selected()?.id)">Enroll</button>
      <button class="btn-outline" (click)="closeDetails()">Close</button>
    </div>
  </div>
</div>

<div class="pager">
  <button (click)="onPageChange(page() - 1)" [disabled]="page() <= 1">Prev</button>
  <span>Page {{ page() }} of {{ (totalCount() || 0) <= 0 ? 1 : Math.ceil((totalCount() || 0) / pageSize()) }}</span>
  <button (click)="onPageChange(page() + 1)" [disabled]="page() * pageSize() >= (totalCount() || 0)">Next</button>
</div>

<button class="fab-add" title="Add Student" (click)="goToAddStudent()">+ Add</button>
